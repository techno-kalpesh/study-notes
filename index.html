<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Notes Hub</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    
    .toast.success { background-color: #10b981; }
    .toast.error { background-color: #ef4444; }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .delete-confirmation {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .upvote-btn {
      transition: all 0.2s ease;
    }

    .upvote-btn:hover {
      transform: scale(1.1);
    }

    .upvote-btn.voted {
      animation: pulse 0.3s ease;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .file-icon {
      font-size: 2em;
      margin-bottom: 8px;
    }

    .filter-btn {
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="w-full min-h-full flex flex-col"></div>
  <script>
    const defaultConfig = {
      background_color: "#f0f9ff",
      surface_color: "#ffffff",
      text_color: "#1e293b",
      primary_action_color: "#3b82f6",
      secondary_action_color: "#64748b",
      font_family: "Inter",
      font_size: 16,
      site_title: "Study Notes Hub",
      site_subtitle: "Share and discover study materials",
      submit_button_text: "Share Notes"
    };
    
    let currentPage = 'home';
    let searchQuery = '';
    let allNotes = [];
    let isSubmitting = false;
    let deleteConfirmId = null;
    let filterFileType = 'all';
    let sortBy = 'recent';
    
    const FILE_TYPES = {
      pdf: { icon: 'üìÑ', label: 'PDF', color: '#ef4444' },
      doc: { icon: 'üìù', label: 'Document', color: '#3b82f6' },
      docx: { icon: 'üìù', label: 'Document', color: '#3b82f6' },
      ppt: { icon: 'üìä', label: 'Presentation', color: '#f97316' },
      pptx: { icon: 'üìä', label: 'Presentation', color: '#f97316' },
      xls: { icon: 'üìà', label: 'Spreadsheet', color: '#10b981' },
      xlsx: { icon: 'üìà', label: 'Spreadsheet', color: '#10b981' },
      jpg: { icon: 'üñºÔ∏è', label: 'Image', color: '#8b5cf6' },
      jpeg: { icon: 'üñºÔ∏è', label: 'Image', color: '#8b5cf6' },
      png: { icon: 'üñºÔ∏è', label: 'Image', color: '#8b5cf6' },
      gif: { icon: 'üñºÔ∏è', label: 'Image', color: '#8b5cf6' },
      mp4: { icon: 'üé•', label: 'Video', color: '#ec4899' },
      zip: { icon: 'üì¶', label: 'Archive', color: '#64748b' },
      txt: { icon: 'üìÉ', label: 'Text', color: '#64748b' },
      default: { icon: 'üìÅ', label: 'File', color: '#64748b' }
    };
    
    const dataHandler = {
      onDataChanged(data) {
        allNotes = data;
        renderPageContent();
      }
    };
    
    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        showToast("Failed to initialize data storage", "error");
      }
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
      
      renderApp();
    }
    
    function detectFileType(driveLink) {
      const url = driveLink.toLowerCase();
      
      for (const [ext, info] of Object.entries(FILE_TYPES)) {
        if (ext !== 'default' && url.includes(`.${ext}`)) {
          return ext;
        }
      }
      
      if (url.includes('/document/') || url.includes('docs.google.com')) return 'doc';
      if (url.includes('/presentation/') || url.includes('slides.google.com')) return 'ppt';
      if (url.includes('/spreadsheets/') || url.includes('sheets.google.com')) return 'xls';
      
      return 'default';
    }
    
    function getFileInfo(fileType) {
      return FILE_TYPES[fileType] || FILE_TYPES.default;
    }
    
    function getViewerLink(driveLink) {
      const fileIdMatch = driveLink.match(/[-\w]{25,}/);
      if (!fileIdMatch) return escapeHtml(driveLink);
      
      const fileId = fileIdMatch[0];
      
      if (driveLink.includes('/file/d/')) {
        return escapeHtml(`https://drive.google.com/file/d/${fileId}/view`);
      } else if (driveLink.includes('/document/d/')) {
        return escapeHtml(`https://docs.google.com/document/d/${fileId}/preview`);
      } else if (driveLink.includes('/presentation/d/')) {
        return escapeHtml(`https://docs.google.com/presentation/d/${fileId}/preview`);
      } else if (driveLink.includes('/spreadsheets/d/')) {
        return escapeHtml(`https://docs.google.com/spreadsheets/d/${fileId}/preview`);
      }
      
      return escapeHtml(driveLink);
    }
    
    function getDownloadLink(driveLink) {
      const fileIdMatch = driveLink.match(/[-\w]{25,}/);
      if (!fileIdMatch) return escapeHtml(driveLink);
      
      const fileId = fileIdMatch[0];
      
      if (driveLink.includes('/file/d/')) {
        return escapeHtml(`https://drive.google.com/uc?export=download&id=${fileId}`);
      } else if (driveLink.includes('/document/d/')) {
        return escapeHtml(`https://docs.google.com/document/d/${fileId}/export?format=pdf`);
      } else if (driveLink.includes('/presentation/d/')) {
        return escapeHtml(`https://docs.google.com/presentation/d/${fileId}/export/pdf`);
      } else if (driveLink.includes('/spreadsheets/d/')) {
        return escapeHtml(`https://docs.google.com/spreadsheets/d/${fileId}/export?format=xlsx`);
      }
      
      return escapeHtml(driveLink);
    }
    
    function getSortedAndFilteredNotes() {
      let filtered = [...allNotes];
      
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(note => 
          note.title.toLowerCase().includes(query) ||
          note.subject.toLowerCase().includes(query) ||
          note.author.toLowerCase().includes(query) ||
          note.description.toLowerCase().includes(query)
        );
      }
      
      if (filterFileType !== 'all') {
        filtered = filtered.filter(note => note.fileType === filterFileType);
      }
      
      filtered.sort((a, b) => {
        if (sortBy === 'popular') {
          return (b.upvotes || 0) - (a.upvotes || 0);
        } else if (sortBy === 'recent') {
          return new Date(b.createdAt) - new Date(a.createdAt);
        }
        return 0;
      });
      
      return filtered;
    }
    
    function renderApp() {
      const config = window.elementSdk?.config || defaultConfig;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      
      document.getElementById('app').innerHTML = `
        <div class="w-full min-h-full" style="background-color: ${bgColor}; font-family: '${customFont}', system-ui, sans-serif; color: ${textColor};">
          <header class="w-full py-6 px-6" style="background-color: ${surfaceColor}; border-bottom: 3px solid ${primaryColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
            <div class="max-w-6xl mx-auto">
              <h1 id="site-title" style="font-size: ${baseSize * 2}px; font-weight: 700; margin: 0 0 8px 0; color: ${primaryColor};">${config.site_title || defaultConfig.site_title}</h1>
              <p id="site-subtitle" style="font-size: ${baseSize * 1.1}px; margin: 0 0 20px 0; opacity: 0.7;">${config.site_subtitle || defaultConfig.site_subtitle}</p>
              
              <nav style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="nav-btn" data-page="home" style="padding: 10px 24px; background-color: ${currentPage === 'home' ? primaryColor : 'transparent'}; color: ${currentPage === 'home' ? 'white' : primaryColor}; border: 2px solid ${primaryColor}; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: '${customFont}', system-ui, sans-serif;">
                  üè† Home
                </button>
                <button class="nav-btn" data-page="browse" style="padding: 10px 24px; background-color: ${currentPage === 'browse' ? primaryColor : 'transparent'}; color: ${currentPage === 'browse' ? 'white' : primaryColor}; border: 2px solid ${primaryColor}; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: '${customFont}', system-ui, sans-serif;">
                  üìö Browse Notes
                </button>
                <button class="nav-btn" data-page="share" style="padding: 10px 24px; background-color: ${currentPage === 'share' ? primaryColor : 'transparent'}; color: ${currentPage === 'share' ? 'white' : primaryColor}; border: 2px solid ${primaryColor}; border-radius: 8px; font-size: ${baseSize}px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: '${customFont}', system-ui, sans-serif;">
                  ‚ûï Share Link
                </button>
              </nav>
              
              ${currentPage === 'browse' ? `
                <div style="margin-top: 20px;">
                  <input type="text" id="search-input" placeholder="üîç Search by title, subject, or author..." value="${searchQuery}" style="width: 100%; max-width: 500px; padding: 12px 16px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; font-family: '${customFont}', system-ui, sans-serif; margin-bottom: 16px;">
                  
                  <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: ${baseSize * 0.9}px; font-weight: 600; opacity: 0.7;">Filter:</span>
                    <button class="filter-btn" data-filter="all" style="padding: 8px 16px; background-color: ${filterFileType === 'all' ? primaryColor : 'transparent'}; color: ${filterFileType === 'all' ? 'white' : textColor}; border: 2px solid ${filterFileType === 'all' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      All Files
                    </button>
                    <button class="filter-btn" data-filter="pdf" style="padding: 8px 16px; background-color: ${filterFileType === 'pdf' ? primaryColor : 'transparent'}; color: ${filterFileType === 'pdf' ? 'white' : textColor}; border: 2px solid ${filterFileType === 'pdf' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      üìÑ PDFs
                    </button>
                    <button class="filter-btn" data-filter="doc" style="padding: 8px 16px; background-color: ${filterFileType === 'doc' ? primaryColor : 'transparent'}; color: ${filterFileType === 'doc' ? 'white' : textColor}; border: 2px solid ${filterFileType === 'doc' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      üìù Docs
                    </button>
                    <button class="filter-btn" data-filter="ppt" style="padding: 8px 16px; background-color: ${filterFileType === 'ppt' ? primaryColor : 'transparent'}; color: ${filterFileType === 'ppt' ? 'white' : textColor}; border: 2px solid ${filterFileType === 'ppt' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      üìä Slides
                    </button>
                    
                    <span style="margin-left: 20px; font-size: ${baseSize * 0.9}px; font-weight: 600; opacity: 0.7;">Sort:</span>
                    <button class="sort-btn" data-sort="recent" style="padding: 8px 16px; background-color: ${sortBy === 'recent' ? primaryColor : 'transparent'}; color: ${sortBy === 'recent' ? 'white' : textColor}; border: 2px solid ${sortBy === 'recent' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      üïí Recent
                    </button>
                    <button class="sort-btn" data-sort="popular" style="padding: 8px 16px; background-color: ${sortBy === 'popular' ? primaryColor : 'transparent'}; color: ${sortBy === 'popular' ? 'white' : textColor}; border: 2px solid ${sortBy === 'popular' ? primaryColor : primaryColor + '44'}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">
                      ‚≠ê Popular
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
          </header>
          
          <main class="w-full max-w-6xl mx-auto px-6 py-8">
            <div id="page-content"></div>
          </main>
        </div>
      `;
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentPage = e.target.dataset.page;
          renderApp();
        });
      });
      
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value;
          renderPageContent();
        });
      }
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          filterFileType = e.target.dataset.filter;
          renderApp();
        });
      });
      
      document.querySelectorAll('.sort-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          sortBy = e.target.dataset.sort;
          renderPageContent();
        });
      });
      
      renderPageContent();
    }
    
    function renderPageContent() {
      const pageContent = document.getElementById('page-content');
      if (!pageContent) return;
      
      if (currentPage === 'home') renderHomePage();
      else if (currentPage === 'browse') renderBrowsePage();
      else if (currentPage === 'share') renderSharePage();
    }
    
    function renderHomePage() {
      const config = window.elementSdk?.config || defaultConfig;
      const pageContent = document.getElementById('page-content');
      if (!pageContent) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      
      const totalNotes = allNotes.length;
      const subjects = [...new Set(allNotes.map(n => n.subject))].length;
      const topRated = [...allNotes].sort((a, b) => (b.upvotes || 0) - (a.upvotes || 0)).slice(0, 3);
      
      pageContent.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 32px;">
          <div style="padding: 32px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border-top: 4px solid ${primaryColor};">
            <div style="font-size: ${baseSize * 3}px; font-weight: 700; color: ${primaryColor}; margin-bottom: 8px;">${totalNotes}</div>
            <div style="font-size: ${baseSize * 1.1}px; opacity: 0.7;">Shared Links</div>
          </div>
          
          <div style="padding: 32px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border-top: 4px solid #10b981;">
            <div style="font-size: ${baseSize * 3}px; font-weight: 700; color: #10b981; margin-bottom: 8px;">${subjects}</div>
            <div style="font-size: ${baseSize * 1.1}px; opacity: 0.7;">Subjects</div>
          </div>
          
          <div style="padding: 32px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: center; border-top: 4px solid #f59e0b;">
            <div style="font-size: ${baseSize * 3}px; font-weight: 700; color: #f59e0b; margin-bottom: 8px;">${allNotes.reduce((sum, n) => sum + (n.upvotes || 0), 0)}</div>
            <div style="font-size: ${baseSize * 1.1}px; opacity: 0.7;">Total Upvotes</div>
          </div>
        </div>
        
        <div style="padding: 32px; background: linear-gradient(135deg, ${primaryColor} 0%, #10b981 100%); border-radius: 12px; color: white; margin-bottom: 40px; text-align: center;">
          <h2 style="font-size: ${baseSize * 1.8}px; font-weight: 700; margin: 0 0 12px 0;">üìö Share Your Study Materials</h2>
          <p style="font-size: ${baseSize * 1.1}px; margin: 0 0 24px 0; opacity: 0.95;">Upload files to Google Drive and share the link here!</p>
          <button class="nav-btn" data-page="share" style="padding: 14px 32px; background-color: white; color: ${primaryColor}; border: none; border-radius: 8px; font-size: ${baseSize * 1.1}px; font-weight: 600; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            ‚ûï Share Your Link
          </button>
        </div>
        
        <h3 style="font-size: ${baseSize * 1.6}px; font-weight: 600; margin: 0 0 20px 0;">‚≠ê Top Rated Resources</h3>
        ${topRated.length > 0 ? `
          <div style="display: grid; gap: 20px;">
            ${topRated.map(note => {
              const fileInfo = getFileInfo(note.fileType);
              return `
              <div style="padding: 24px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid ${fileInfo.color};">
                <div style="display: flex; gap: 20px; align-items: start; flex-wrap: wrap;">
                  <div style="text-align: center; min-width: 80px;">
                    <div class="file-icon">${fileInfo.icon}</div>
                    <span style="display: inline-block; padding: 4px 10px; background-color: ${fileInfo.color}22; color: ${fileInfo.color}; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-weight: 600;">${fileInfo.label}</span>
                  </div>
                  
                  <div style="flex: 1; min-width: 250px;">
                    <h4 style="font-size: ${baseSize * 1.3}px; font-weight: 600; margin: 0 0 8px 0; color: ${textColor};">${escapeHtml(note.title)}</h4>
                    <span style="display: inline-block; padding: 4px 12px; background-color: ${primaryColor}22; color: ${primaryColor}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; margin-bottom: 12px;">${escapeHtml(note.subject)}</span>
                    <p style="font-size: ${baseSize * 0.95}px; margin: 12px 0; opacity: 0.8; line-height: 1.6;">${escapeHtml(note.description.substring(0, 120))}${note.description.length > 120 ? '...' : ''}</p>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid ${primaryColor}22; flex-wrap: wrap; gap: 12px;">
                      <div style="display: flex; gap: 16px; align-items: center;">
                        <span style="font-size: ${baseSize * 0.85}px; opacity: 0.6;">By ${escapeHtml(note.author)}</span>
                        <span style="font-size: ${baseSize * 0.9}px; font-weight: 600; color: #f59e0b;">‚≠ê ${note.upvotes || 0} upvotes</span>
                      </div>
                      <div style="display: flex; gap: 8px;">
                        <a href="${getViewerLink(note.driveLink)}" target="_blank" rel="noopener noreferrer" style="padding: 8px 20px; background-color: ${primaryColor}; color: white; text-decoration: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; font-weight: 500; font-family: '${customFont}', system-ui, sans-serif;">üëÅÔ∏è Preview</a>
                        <a href="${getDownloadLink(note.driveLink)}" target="_blank" rel="noopener noreferrer" style="padding: 8px 20px; background-color: #10b981; color: white; text-decoration: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; font-weight: 500; font-family: '${customFont}', system-ui, sans-serif;">‚¨áÔ∏è Download</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `}).join('')}
          </div>
        ` : `
          <div style="text-align: center; padding: 60px 20px; background-color: ${surfaceColor}; border-radius: 12px; opacity: 0.6;">
            <p style="font-size: ${baseSize * 1.2}px; margin: 0;">No links shared yet. Be the first! üöÄ</p>
          </div>
        `}
      `;
      
      pageContent.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          currentPage = e.target.dataset.page;
          renderApp();
        });
      });
    }
    
    function renderBrowsePage() {
      const config = window.elementSdk?.config || defaultConfig;
      const pageContent = document.getElementById('page-content');
      if (!pageContent) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryColor = config.secondary_action_color || defaultConfig.secondary_action_color;
      
      const filteredNotes = getSortedAndFilteredNotes();
      const subjects = [...new Set(allNotes.map(n => n.subject))].sort();
      const notesBySubject = {};
      subjects.forEach(subject => {
        notesBySubject[subject] = filteredNotes.filter(n => n.subject === subject);
      });
      
      pageContent.innerHTML = `
        <h2 style="font-size: ${baseSize * 1.8}px; font-weight: 700; margin: 0 0 24px 0;">üìö Browse All Notes</h2>
        
        ${searchQuery || filterFileType !== 'all' ? `
          <div style="padding: 16px 24px; background-color: ${surfaceColor}; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid ${primaryColor};">
            <p style="font-size: ${baseSize}px; margin: 0;">
              Found <strong>${filteredNotes.length}</strong> result${filteredNotes.length !== 1 ? 's' : ''}
              ${searchQuery ? ` for "${escapeHtml(searchQuery)}"` : ''}
              ${filterFileType !== 'all' ? ` (${getFileInfo(filterFileType).label} files only)` : ''}
            </p>
          </div>
        ` : ''}
        
        <div id="notes-container"></div>
      `;
      
      const notesContainer = document.getElementById('notes-container');
      if (filteredNotes.length === 0) {
        notesContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background-color: ${surfaceColor}; border-radius: 12px; opacity: 0.6;">
            <p style="font-size: ${baseSize * 1.2}px; margin: 0;">${searchQuery || filterFileType !== 'all' ? 'No notes found matching your filters.' : 'No notes available yet.'}</p>
          </div>
        `;
        return;
      }
      
      subjects.forEach(subject => {
        const subjectNotes = notesBySubject[subject];
        if (subjectNotes.length === 0) return;
        
        const subjectDiv = document.createElement('div');
        subjectDiv.style.marginBottom = '40px';
        subjectDiv.innerHTML = `
          <h3 style="font-size: ${baseSize * 1.5}px; font-weight: 600; margin: 0 0 20px 0; padding-bottom: 12px; border-bottom: 3px solid ${primaryColor}; color: ${textColor};">
            ${escapeHtml(subject)} <span style="opacity: 0.5; font-weight: 400;">(${subjectNotes.length})</span>
          </h3>
          <div style="display: grid; gap: 20px;">
            ${subjectNotes.map(note => {
              const fileInfo = getFileInfo(note.fileType);
              return `
              <div class="note-card" data-note-id="${note.__backendId}" style="padding: 24px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid ${fileInfo.color};">
                <div style="display: flex; gap: 20px; align-items: start; flex-wrap: wrap;">
                  <div style="text-align: center; min-width: 80px;">
                    <div class="file-icon">${fileInfo.icon}</div>
                    <span style="display: inline-block; padding: 4px 10px; background-color: ${fileInfo.color}22; color: ${fileInfo.color}; border-radius: 6px; font-size: ${baseSize * 0.75}px; font-weight: 600; margin-bottom: 8px;">${fileInfo.label}</span>
                    <div style="margin-top: 12px;">
                      <button class="upvote-btn" data-note-id="${note.__backendId}" style="padding: 8px 16px; background-color: #f59e0b22; color: #f59e0b; border: 2px solid #f59e0b; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 600; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif; display: flex; align-items: center; gap: 6px; justify-content: center;">
                        <span style="font-size: ${baseSize * 1.2}px;">‚≠ê</span>
                        <span>${note.upvotes || 0}</span>
                      </button>
                    </div>
                  </div>
                  
                  <div style="flex: 1; min-width: 250px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; gap: 16px; flex-wrap: wrap;">
                      <div style="flex: 1;">
                        <h4 style="font-size: ${baseSize * 1.3}px; font-weight: 600; margin: 0 0 8px 0; color: ${textColor};">${escapeHtml(note.title)}</h4>
                        <span style="display: inline-block; padding: 4px 12px; background-color: ${secondaryColor}22; color: ${secondaryColor}; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500;">${escapeHtml(note.subject)}</span>
                      </div>
                      <div id="delete-area-${note.__backendId}">
                        <button class="delete-btn" data-note-id="${note.__backendId}" style="padding: 8px 16px; background-color: transparent; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">Delete</button>
                      </div>
                    </div>
                    
                    <p style="font-size: ${baseSize}px; margin: 0 0 16px 0; line-height: 1.7; color: ${textColor}; opacity: 0.85;">${escapeHtml(note.description)}</p>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid ${secondaryColor}22; flex-wrap: wrap; gap: 12px;">
                      <span style="font-size: ${baseSize * 0.85}px; opacity: 0.6;">By ${escapeHtml(note.author)} ‚Ä¢ ${formatDate(note.createdAt)}</span>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="${getViewerLink(note.driveLink)}" target="_blank" rel="noopener noreferrer" style="padding: 10px 20px; background-color: ${primaryColor}; color: white; text-decoration: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; font-weight: 500; font-family: '${customFont}', system-ui, sans-serif;">üëÅÔ∏è Preview</a>
                        <a href="${getDownloadLink(note.driveLink)}" target="_blank" rel="noopener noreferrer" style="padding: 10px 20px; background-color: #10b981; color: white; text-decoration: none; border-radius: 6px; font-size: ${baseSize * 0.9}px; font-weight: 500; font-family: '${customFont}', system-ui, sans-serif;">‚¨áÔ∏è Download</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `}).join('')}
          </div>
        `;
        notesContainer.appendChild(subjectDiv);
      });
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDeleteClick);
      });
      
      document.querySelectorAll('.upvote-btn').forEach(btn => {
        btn.addEventListener('click', handleUpvoteClick);
      });
    }
    
    function renderSharePage() {
      const config = window.elementSdk?.config || defaultConfig;
      const pageContent = document.getElementById('page-content');
      if (!pageContent) return;
      
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      
      if (allNotes.length >= 999) {
        pageContent.innerHTML = `
          <div style="padding: 40px; background-color: ${surfaceColor}; border-radius: 12px; text-align: center; border: 2px solid #ef4444;">
            <h2 style="font-size: ${baseSize * 1.6}px; font-weight: 600; margin: 0 0 16px 0; color: #ef4444;">‚ö†Ô∏è Limit Reached</h2>
            <p style="font-size: ${baseSize * 1.1}px; margin: 0; opacity: 0.8;">Maximum limit of 999 links reached. Please delete some links before adding new ones.</p>
          </div>
        `;
        return;
      }
      
      pageContent.innerHTML = `
        <div style="max-width: 700px; margin: 0 auto; padding: 32px; background-color: ${surfaceColor}; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
          <h2 style="font-size: ${baseSize * 1.8}px; font-weight: 700; margin: 0 0 12px 0; color: ${primaryColor};">üì§ Share Your Study Link</h2>
          <p style="font-size: ${baseSize}px; margin: 0 0 32px 0; opacity: 0.7;">Upload your files to Google Drive and paste the shareable link below</p>
          
          <form id="share-form">
            <div style="margin-bottom: 20px;">
              <label for="note-title" style="display: block; font-size: ${baseSize * 0.95}px; font-weight: 600; margin-bottom: 8px; color: ${textColor};">Title *</label>
              <input type="text" id="note-title" required placeholder="e.g., Biology Chapter 5 Notes" style="width: 100%; padding: 14px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; font-family: '${customFont}', system-ui, sans-serif;">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="note-subject" style="display: block; font-size: ${baseSize * 0.95}px; font-weight: 600; margin-bottom: 8px; color: ${textColor};">Subject *</label>
              <input type="text" id="note-subject" required placeholder="e.g., Biology, Mathematics" style="width: 100%; padding: 14px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; font-family: '${customFont}', system-ui, sans-serif;">
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="note-description" style="display: block; font-size: ${baseSize * 0.95}px; font-weight: 600; margin-bottom: 8px; color: ${textColor};">Description *</label>
              <textarea id="note-description" required rows="4" placeholder="Brief overview of what this link contains..." style="width: 100%; padding: 14px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; resize: vertical; font-family: '${customFont}', system-ui, sans-serif;"></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
              <label for="drive-link" style="display: block; font-size: ${baseSize * 0.95}px; font-weight: 600; margin-bottom: 8px; color: ${textColor};">Google Drive Link *</label>
              <input type="url" id="drive-link" required placeholder="https://drive.google.com/..." style="width: 100%; padding: 14px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; font-family: '${customFont}', system-ui, sans-serif;">
              <p style="font-size: ${baseSize * 0.85}px; margin: 8px 0 0 0; opacity: 0.6;">üí° Make sure your link is set to "Anyone with the link can view"</p>
            </div>
            
            <div style="margin-bottom: 28px;">
              <label for="note-author" style="display: block; font-size: ${baseSize * 0.95}px; font-weight: 600; margin-bottom: 8px; color: ${textColor};">Your Name *</label>
              <input type="text" id="note-author" required placeholder="e.g., John Doe" style="width: 100%; padding: 14px; border: 2px solid ${primaryColor}33; background-color: white; color: ${textColor}; border-radius: 8px; font-size: ${baseSize}px; font-family: '${customFont}', system-ui, sans-serif;">
            </div>
            
            <button type="submit" id="submit-btn" style="width: 100%; padding: 16px; background-color: ${primaryColor}; color: white; border: none; border-radius: 8px; font-size: ${baseSize * 1.15}px; font-weight: 600; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif; box-shadow: 0 4px 12px ${primaryColor}44;">
              ${config.submit_button_text || defaultConfig.submit_button_text}
            </button>
          </form>
        </div>
      `;
      
      document.getElementById('share-form').addEventListener('submit', handleSubmit);
    }
    
    function handleDeleteClick(e) {
      const noteId = e.target.dataset.noteId;
      const config = window.elementSdk?.config || defaultConfig;
      const baseSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      
      const deleteArea = document.getElementById(`delete-area-${noteId}`);
      deleteArea.innerHTML = `
        <div class="delete-confirmation">
          <span style="font-size: ${baseSize * 0.85}px; color: #ef4444; font-weight: 500;">Delete?</span>
          <button class="confirm-delete-btn" data-note-id="${noteId}" style="padding: 6px 14px; background-color: #ef4444; color: white; border: none; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">Yes</button>
          <button class="cancel-delete-btn" data-note-id="${noteId}" style="padding: 6px 14px; background-color: transparent; color: #64748b; border: 1px solid #64748b; border-radius: 6px; font-size: ${baseSize * 0.85}px; font-weight: 500; cursor: pointer; font-family: '${customFont}', system-ui, sans-serif;">No</button>
        </div>
      `;
      
      deleteArea.querySelector('.confirm-delete-btn').addEventListener('click', handleConfirmDelete);
      deleteArea.querySelector('.cancel-delete-btn').addEventListener('click', () => {
        renderPageContent();
      });
    }
    
    async function handleConfirmDelete(e) {
      const noteId = e.target.dataset.noteId;
      const note = allNotes.find(n => n.__backendId === noteId);
      if (!note) return;
      
      const deleteArea = document.getElementById(`delete-area-${noteId}`);
      deleteArea.innerHTML = `<span style="color: #64748b; font-size: ${(window.elementSdk?.config?.font_size || defaultConfig.font_size) * 0.85}px;">Deleting...</span>`;
      
      const result = await window.dataSdk.delete(note);
      
      if (result.isOk) {
        showToast("Link deleted successfully", "success");
      } else {
        showToast("Failed to delete link", "error");
        renderPageContent();
      }
    }
    
    async function handleUpvoteClick(e) {
      const noteId = e.currentTarget.dataset.noteId;
      const note = allNotes.find(n => n.__backendId === noteId);
      if (!note) return;
      
      const btn = e.currentTarget;
      btn.style.opacity = '0.6';
      btn.style.cursor = 'not-allowed';
      btn.disabled = true;
      
      const updatedNote = {
        ...note,
        upvotes: (note.upvotes || 0) + 1
      };
      
      const result = await window.dataSdk.update(updatedNote);
      
      if (result.isOk) {
        btn.classList.add('voted');
        showToast("Upvoted! ‚≠ê", "success");
        setTimeout(() => {
          btn.classList.remove('voted');
        }, 300);
      } else {
        showToast("Failed to upvote", "error");
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        btn.disabled = false;
      }
    }
    
    async function handleSubmit(e) {
      e.preventDefault();
      
      if (isSubmitting) return;
      if (allNotes.length >= 999) {
        showToast("Maximum limit of 999 links reached", "error");
        return;
      }
      
      isSubmitting = true;
      const config = window.elementSdk?.config || defaultConfig;
      const submitBtn = document.getElementById('submit-btn');
      submitBtn.style.opacity = '0.6';
      submitBtn.style.cursor = 'not-allowed';
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading-spinner"></span> Sharing...';
      
      const title = document.getElementById('note-title').value;
      const subject = document.getElementById('note-subject').value;
      const description = document.getElementById('note-description').value;
      const driveLink = document.getElementById('drive-link').value;
      const author = document.getElementById('note-author').value;
      const fileType = detectFileType(driveLink);
      
      const result = await window.dataSdk.create({
        title,
        subject,
        description,
        driveLink,
        author,
        fileType,
        upvotes: 0,
        createdAt: new Date().toISOString()
      });
      
      if (result.isOk) {
        document.getElementById('share-form').reset();
        showToast("Link shared successfully!", "success");
        setTimeout(() => {
          currentPage = 'browse';
          renderApp();
        }, 1000);
      } else {
        showToast("Failed to share link. Please try again.", "error");
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.disabled = false;
        submitBtn.textContent = config.submit_button_text || defaultConfig.submit_button_text;
      }
      
      isSubmitting = false;
    }
    
    function showToast(message, type) {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
      });
    }
    
    async function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action_color || defaultConfig.primary_action_color;
      
      const appContainer = document.querySelector('#app > div');
      if (appContainer) {
        appContainer.style.backgroundColor = bgColor;
        appContainer.style.fontFamily = `'${customFont}', system-ui, sans-serif`;
        appContainer.style.color = textColor;
      }
      
      const header = document.querySelector('header');
      if (header) {
        header.style.backgroundColor = surfaceColor;
        header.style.borderBottomColor = primaryColor;
      }
      
      const siteTitle = document.getElementById('site-title');
      if (siteTitle) {
        siteTitle.style.fontSize = `${baseSize * 2}px`;
        siteTitle.style.color = primaryColor;
        siteTitle.textContent = config.site_title || defaultConfig.site_title;
      }
      
      const siteSubtitle = document.getElementById('site-subtitle');
      if (siteSubtitle) {
        siteSubtitle.style.fontSize = `${baseSize * 1.1}px`;
        siteSubtitle.textContent = config.site_subtitle || defaultConfig.site_subtitle;
      }
      
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn && !isSubmitting) {
        submitBtn.style.backgroundColor = primaryColor;
        submitBtn.style.fontSize = `${baseSize * 1.15}px`;
        submitBtn.textContent = config.submit_button_text || defaultConfig.submit_button_text;
      }
      
      renderPageContent();
    }
    
    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.primary_action_color || defaultConfig.primary_action_color,
            set: (value) => {
              config.primary_action_color = value;
              window.elementSdk.setConfig({ primary_action_color: value });
            }
          },
          {
            get: () => config.secondary_action_color || defaultConfig.secondary_action_color,
            set: (value) => {
              config.secondary_action_color = value;
              window.elementSdk.setConfig({ secondary_action_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }
    
    function mapToEditPanelValues(config) {
      return new Map([
        ["site_title", config.site_title || defaultConfig.site_title],
        ["site_subtitle", config.site_subtitle || defaultConfig.site_subtitle],
        ["submit_button_text", config.submit_button_text || defaultConfig.submit_button_text]
      ]);
    }
    
    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a57b90db722c464',t:'MTc2NDMxMDQ0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
